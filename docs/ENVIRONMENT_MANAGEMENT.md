# TaskFlow Environment Management Guide

<details>
<summary>English version</summary>

---

# TaskFlow Environment Management Guide (English)

This document explains how to manage environment variables across different environments (development, production) in TaskFlow without manual file changes.

> ‚ö†Ô∏è The sections below were updated for the profile-based workflow (November 2025). Legacy notes referencing `.env` files are kept later in the document for historical context and will be pruned as the migration completes.

## üìã Overview

TaskFlow now keeps reusable **environment profiles** under `config/environments`. Each profile describes:

- The environment variables to apply for API, Functions, and frontend projects.
- The configuration files that should be copied into place (typically from `config/secrets/<profile>/`).

Profiles are activated with the PowerShell helper:

```powershell
scripts\use-env.ps1 <profile-name>
```

The script sets the variables for the current shell and copies the referenced configuration files (API `appsettings.Local.json`, Functions `local.settings.json`, frontend `.env.local`, etc.). Real secrets live outside git inside `config/secrets/`, while `*.ps1.example` templates document the structure.

### Frontend (Vite)
- Local development: `.env.local` (generated/copied by the profile script)
- Production build: hosting platform variables (`VITE_*`) or pipeline injection

### Backend (ASP.NET Core)
- Base configuration: `appsettings.json`
- Environment overrides: `appsettings.Development.json`, `appsettings.Production.json`, ‚Ä¶
- Developer-specific secrets: `appsettings.Local.json` (copied by the profile script and ignored by git)

## üéØ How It Works

### Frontend Environment Detection

Vite automatically detects which `.env` file to load based on the command you run:

| Command | Environment | File Loaded |
|---------|-------------|-------------|
| `npm run dev` | development | `.env.development` |
| `npm run build` | production | `.env.production` |
| `npm run preview` | production | `.env.production` |

**No manual changes needed!** Vite handles everything automatically.

### Backend Environment Detection

Aps.NET Core uses the default hierarchy of configuration sources (later sources override earlier ones):

1. `appsettings.json` (base configuration)
2. `appsettings.{Environment}.json` (environment-specific overrides)
3. `appsettings.Local.json` (optional, ignored by git, populated by the profile script)
4. Environment variables (set by `scripts/use-env.ps1`, Azure App Settings, or GitHub Secrets)

The environment is determined by the `ASPNETCORE_ENVIRONMENT` variable:
- **Development**: Set automatically by Visual Studio / `dotnet run` / `launchSettings.json`
- **Production**: Set by `--launch-profile production` or hosting platform (Azure, Railway, Render)

The `scripts/use-env.ps1` script also sets `ASPNETCORE_ENVIRONMENT`, `DOTNET_ENVIRONMENT`, and `FUNCTIONS_ENVIRONMENT`, so launch profiles and Functions worker pick up the correct configuration automatically. When you need to test another profile, re-run the script (remember each new shell needs to execute it).

## üìÅ File Structure

```
taskflow/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ environments/             # Reusable profiles (tracked templates + local overrides)
‚îÇ   ‚îî‚îÄ‚îÄ secrets/                  # Local-only secret files referenced by profiles
‚îÇ
‚îú‚îÄ‚îÄ TaskFlow.Api/
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.json          # Base config
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Development.json
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Production.json
‚îÇ   ‚îî‚îÄ‚îÄ appsettings.Local.json    # Generated by scripts/use-env.ps1 (ignored by git)
‚îÇ
‚îú‚îÄ‚îÄ TaskFlow.Functions/
‚îÇ   ‚îî‚îÄ‚îÄ local.settings.json       # Generated by scripts/use-env.ps1 (ignored by git)
‚îÇ
‚îî‚îÄ‚îÄ taskflow-frontend/
   ‚îî‚îÄ‚îÄ .env.local                # Generated by scripts/use-env.ps1 (ignored by git)
```

## ‚öôÔ∏è Configuration Files

### Frontend `.env.development`

Used when running `npm run dev`:

```env
# Development environment - Backend running on localhost
VITE_ROOT_URL=http://localhost:5149
VITE_GOOGLE_MAPS_API_KEY=your_api_key_here
```

### Frontend `.env.production`

Used when running `npm run build`:

```env
# Production environment - Replace with your actual domain
VITE_ROOT_URL=https://your-domain.com
VITE_GOOGLE_MAPS_API_KEY=your_api_key_here
```

### Backend `.env.development`

Used for local development secrets (localhost database):

```env
ConnectionStrings__DefaultConnection=Server=localhost\SQLEXPRESS;Database=TaskFlowDb;Trusted_Connection=True;TrustServerCertificate=True;
Smtp__Host=smtp.gmail.com
Smtp__Port=587
Smtp__User=your-email@gmail.com
Smtp__Pass=your-gmail-app-password
Smtp__From=your-email@gmail.com
Jwt__Key=your-secret-key-minimum-32-characters
FRONTEND_URL=http://localhost:5173
```

### Backend `.env.production`

Used for local testing with production configuration (Azure database):

```env
ConnectionStrings__DefaultConnection=Server=tcp:your-server.database.windows.net,1433;Initial Catalog=taskflow-db;User ID=admin;Password=pass;Encrypt=True;
Smtp__Host=smtp.gmail.com
Smtp__Port=587
Smtp__User=your-email@gmail.com
Smtp__Pass=your-gmail-app-password
Smtp__From=your-email@gmail.com
Jwt__Key=your-production-secret-key
FRONTEND_URL=https://your-app.azurewebsites.net
```

**Note**: This file is NOT committed to git. In Azure, the GitHub Actions workflow creates this file dynamically from GitHub Secrets during deployment.

### Backend `appsettings.Production.json`

Template for production configuration (credentials filled by hosting platform):

```json
{
  "ConnectionStrings": {
    "DefaultConnection": ""
  },
  "Smtp": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "User": "",
    "Pass": "",
    "From": "TaskFlow <your-email@gmail.com>"
  },
  "Jwt": {
    "Key": "",
    "Issuer": "TaskFlowApi",
    "Audience": "TaskFlowClient",
    "ExpiresInMinutes": 60
  },
   "AI": {
      "Provider": "huggingface",
      "ApiKey": "",
      "Model": "HuggingFaceTB/SmolLM3-3B",
      "BaseUrl": "https://router.huggingface.co",
      "TimeoutSeconds": 90
   }
}
```

## üîÑ Workflows

### Workflow 1: Development (Hot-Reload)

**Use case**: Active development with automatic reloading

**Frontend**:
```bash
cd taskflow-frontend
npm run dev
# Automatically loads .env.development
# Backend URL: http://localhost:5149
```

**Backend**:
```bash
cd TaskFlow.Api
dotnet run
# Automatically loads .env file
# ASPNETCORE_ENVIRONMENT=Development (default)
```

**Result**: Frontend on `http://localhost:5173`, Backend on `http://localhost:5149`

---

### Workflow 2: Local Production Testing (NEW!)

**Use case**: Test production configuration locally (Azure database + SMTP) without deploying

**Setup** `.env.production` with Azure database connection string (see example above)

**Backend**:
```bash
cd TaskFlow.Api
dotnet run --launch-profile production
# Uses .env.production
# ASPNETCORE_ENVIRONMENT=Production
# Connects to Azure SQL Database
```

**Frontend** (development mode for hot-reload):
```bash
cd taskflow-frontend
npm run dev
# Uses .env.development (localhost:5149)
# Access at http://localhost:5173
```

**Result**: Test registration/email confirmation locally before committing changes to Azure

---

### Workflow 3: Testing Integrated Production Build

**Use case**: Test full production build locally (frontend + backend together)

**Build and deploy**:
```powershell
# From project root
.\copy-frontend-to-wwwroot.ps1
cd TaskFlow.Api
dotnet run --launch-profile production
# Serves frontend from wwwroot/
# Uses .env.production
# Access at http://localhost:5149
```

**Result**: Complete production environment on `http://localhost:5149`

---

### Workflow 4: Azure Production Deployment

**Use case**: Deploy to Azure App Service via GitHub Actions

**Setup GitHub Secrets** (one-time):
- `AZUREAPPSERVICE_PUBLISHPROFILE`
- `DB_CONNECTION_STRING`
- `SMTP_USER`, `SMTP_PASSWORD`, `SMTP_FROM`
- `JWT_KEY`
- `GOOGLE_MAPS_API_KEY`

**Deploy**:
```bash
git push origin main
```

**GitHub Actions automatically**:
- Creates `.env.production` from secrets
- Builds frontend with production config
- Builds backend
- Deploys to Azure
- Attempts restart (manual restart recommended after first deploy)

**Railway Example**:
```bash
# Environment variables configured in Railway dashboard:
ConnectionStrings__DefaultConnection=postgresql://user:pass@host:5432/db
Smtp__Host=smtp.gmail.com
Smtp__User=your-email@gmail.com
Smtp__Pass=your-app-password
Jwt__Key=your-production-jwt-key
FRONTEND_URL=https://your-app.up.railway.app
```

**Result**: App running on Railway with PostgreSQL database

## üöÄ Switching Environments

### No Manual Changes Needed!

The beauty of this setup is that you **never** need to manually edit environment files to switch between development and production.

| Task | Command | Files Used |
|------|---------|------------|
| Dev with hot-reload | `npm run dev` + `dotnet run` | `.env.development` (both) |
| Test prod config locally | `npm run dev` + `dotnet run --launch-profile production` | `.env.development` (FE), `.env.production` (BE) |
| Build for production | `npm run build` | `.env.production` |
| Test full prod build | `.\copy-frontend-to-wwwroot.ps1` + `dotnet run --launch-profile production` | `.env.production` (both) |
| Deploy to Azure | `git push origin main` | GitHub Secrets ‚Üí `.env.production` created by CI/CD |

### When to Update Each File

**Update `.env.development`**:
- When your local backend port changes
- When you get a new Google Maps API key
- Never commit this if it contains secrets

**Update `.env.production`**:
- Before first production deployment (set your domain)
- When deploying to a new domain
- When production API keys change

**Update `TaskFlow.Api/.env.development`**:
- When local database connection changes
- When you rotate local SMTP credentials
- When you generate new JWT keys for testing
- **Never commit this file** (already in .gitignore)

**Update `TaskFlow.Api/.env.production`**:
- When you want to test Azure database connection locally
- When testing SMTP settings before deploying
- To debug production issues locally
- **Never commit this file** (already in .gitignore)
- Note: In Azure, this file is created by GitHub Actions from secrets

**Update GitHub Secrets** (for Azure):
- When rotating SMTP passwords (regenerate Gmail App Password)
- When changing JWT keys
- When updating database credentials
- When deploying to new Azure resources

**Update `appsettings.Production.json`**:
- When you add new configuration sections
- To set production-specific defaults
- Can commit this (should not contain secrets)

## üîí Security Best Practices

### ‚úÖ DO:
- ‚úÖ Use `.env.example` files as templates
- ‚úÖ Keep secrets in `.env` files (ignored by git)
- ‚úÖ Use environment variables in production
- ‚úÖ Rotate JWT keys regularly
- ‚úÖ Use different keys for dev/prod

### ‚ùå DON'T:
- ‚ùå Commit `.env` files with secrets
- ‚ùå Hardcode secrets in source code
- ‚ùå Use production secrets in development
- ‚ùå Share `.env` files via chat/email
- ‚ùå Use weak JWT keys (< 32 characters)

## üêõ Troubleshooting

### Problem: Frontend can't connect to backend

**Symptoms**: API calls fail, CORS errors, network errors

**Solutions**:
1. Check `VITE_ROOT_URL` in current environment file:
   ```bash
   # Development
   cat taskflow-frontend/.env.development
   
   # Production
   cat taskflow-frontend/.env.production
   ```

2. Verify backend is running on expected port:
   ```bash
   # Should show "Now listening on: http://localhost:5149"
   cd TaskFlow.Api
   dotnet run
   ```

3. Rebuild frontend if you changed `.env` files:
   ```bash
   # Vite only reads .env files at build time
   npm run dev  # For development
   npm run build  # For production
   ```

---

### Problem: Backend can't connect to database

**Symptoms**: Migration errors, "Cannot open database" errors

**Solutions**:
1. Check connection string in `.env` file:
   ```bash
   cat TaskFlow.Api/.env | grep ConnectionStrings
   ```

2. Verify SQL Server is running:
   ```bash
   # Windows
   Get-Service MSSQL*
   
   # Or check in SQL Server Configuration Manager
   ```

3. Test connection string format:
   ```
   # Local SQL Server Express
   Server=localhost\SQLEXPRESS;Database=TaskFlowDb;Trusted_Connection=True;TrustServerCertificate=True;
   
   # SQL Server with credentials
   Server=localhost;Database=TaskFlowDb;User Id=sa;Password=YourPassword;TrustServerCertificate=True;
   ```

---

### Problem: Email confirmation links go to wrong URL

**Symptoms**: Email links point to localhost in production, or wrong port

**Solutions**:
1. Check `FRONTEND_URL` environment variable:
   ```bash
   # Development (.env file)
   FRONTEND_URL=http://localhost:5149
   
   # Production (platform environment variable)
   FRONTEND_URL=https://your-domain.com
   ```

2. Verify backend is reading the variable:
   ```csharp
   // In AuthService.cs, the link is generated like:
   var confirmationLink = $"{_configuration["FRONTEND_URL"]}/confirm-email?token={token}";
   ```

3. Restart backend after changing environment variables

---

### Problem: Changes to `.env` files not taking effect

**Symptoms**: App still uses old values after editing `.env`

**Solutions**:
1. **Frontend**: Restart dev server or rebuild:
   ```bash
   # Stop dev server (Ctrl+C)
   npm run dev  # Start again
   
   # Or for production build:
   npm run build
   ```

2. **Backend**: Restart application:
   ```bash
   # Stop backend (Ctrl+C)
   dotnet run  # Start again
   ```

3. **Clear build cache** if problems persist:
   ```bash
   # Frontend
   rm -rf node_modules/.vite
   npm run dev
   
   # Backend
   dotnet clean
   dotnet build
   ```

---

### Problem: Production build works locally but fails on cloud

**Symptoms**: App works with `dotnet run` but fails on Railway/Render

**Solutions**:
1. Check environment variables are set in platform dashboard

2. Verify `appsettings.Production.json` exists and is valid JSON

3. Check logs in platform dashboard for specific errors

4. Ensure PostgreSQL connection string format for cloud:
   ```
   # Railway/Render PostgreSQL format
   postgresql://user:password@hostname:5432/database?sslmode=require
   ```

5. Verify migrations are applied (Railway runs migrations automatically if configured)

## üìö Additional Resources

- [Vite Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
- [ASP.NET Core Configuration](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)
- [DotNetEnv Library](https://github.com/tonerdo/dotnet-env)
- [Railway Environment Variables](https://docs.railway.app/develop/variables)

---

**Last Updated**: January 2025  
**TaskFlow Version**: 1.0

</details>

---

# Gu√≠a de Gesti√≥n de Entornos de TaskFlow (Espa√±ol)

Este documento explica c√≥mo gestionar variables de entorno en diferentes entornos (desarrollo, producci√≥n) en TaskFlow sin cambios manuales en los archivos.

## üìã Resumen

TaskFlow usa archivos de configuraci√≥n espec√≠ficos por entorno que se seleccionan autom√°ticamente bas√°ndose en el entorno actual:

### Frontend (Vite)
- **Desarrollo**: `.env.development` (se carga autom√°ticamente con `npm run dev`)
- **Producci√≥n**: `.env.production` (se carga autom√°ticamente con `npm run build`)

### Backend (ASP.NET Core)
- **Desarrollo**: `TaskFlow.Api/.env` + `appsettings.Development.json`
- **Producci√≥n**: Variables de entorno (Railway/Render/Azure) + `appsettings.Production.json`

## üéØ C√≥mo Funciona

### Detecci√≥n de Entorno en Frontend

Vite detecta autom√°ticamente qu√© archivo `.env` cargar bas√°ndose en el comando que ejecut√°s:

| Comando | Entorno | Archivo Cargado |
|---------|---------|-----------------|
| `npm run dev` | development | `.env.development` |
| `npm run build` | production | `.env.production` |
| `npm run preview` | production | `.env.production` |

**¬°No se necesitan cambios manuales!** Vite maneja todo autom√°ticamente.

### Detecci√≥n de Entorno en Backend

ASP.NET Core usa una jerarqu√≠a de fuentes de configuraci√≥n (las fuentes posteriores sobrescriben las anteriores):

1. `appsettings.json` (configuraci√≥n base)
2. `appsettings.{Environment}.json` (sobrescrituras espec√≠ficas del entorno)
3. Variables de entorno
4. Archivo `.env` (cargado v√≠a biblioteca DotNetEnv)

El entorno se determina por la variable `ASPNETCORE_ENVIRONMENT`:
- **Development**: Configurado autom√°ticamente por Visual Studio / `dotnet run`
- **Production**: Configurado por la plataforma de hosting (Railway, Render, Azure)

## üìÅ Estructura de Archivos

```
taskflow/
‚îú‚îÄ‚îÄ taskflow-frontend/
‚îÇ   ‚îú‚îÄ‚îÄ .env.development          # Config de desarrollo (localhost:5149)
‚îÇ   ‚îú‚îÄ‚îÄ .env.production           # Config de producci√≥n (tu dominio o Azure)
‚îÇ   ‚îî‚îÄ‚îÄ .env.example              # Plantilla con valores vac√≠os
‚îÇ
‚îú‚îÄ‚îÄ TaskFlow.Api/
‚îÇ   ‚îú‚îÄ‚îÄ .env                      # Secretos de desarrollo local
‚îÇ   ‚îú‚îÄ‚îÄ .env.development          # Config desarrollo (Azure SQL + SMTP)
‚îÇ   ‚îú‚îÄ‚îÄ .env.production           # Config producci√≥n (Azure SQL + SMTP)
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.json          # Configuraci√≥n base
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Development.json  # Sobrescrituras dev (opcional)
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Production.json   # Plantilla config producci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ Properties/
‚îÇ       ‚îî‚îÄ‚îÄ launchSettings.json   # Perfiles de ejecuci√≥n (http, production)
```

## ‚öôÔ∏è Archivos de Configuraci√≥n

### Frontend `.env.development`

Usado al ejecutar `npm run dev`:

```env
# Entorno de desarrollo - Backend corriendo en localhost
VITE_ROOT_URL=http://localhost:5149
VITE_GOOGLE_MAPS_API_KEY=tu_clave_api_aqui
```

### Frontend `.env.production`

Usado al ejecutar `npm run build`:

```env
# Entorno de producci√≥n - Reemplaz√° con tu dominio real
VITE_ROOT_URL=https://tu-dominio.com
VITE_GOOGLE_MAPS_API_KEY=tu_clave_api_aqui
```

### Backend `.env.development`

Usado para desarrollo local con Azure SQL Database:

```env
ConnectionStrings__DefaultConnection=Server=tcp:tu-servidor.database.windows.net,1433;Initial Catalog=taskflow-db;User ID=tu-usuario;Password=tu-password;
Smtp__Host=smtp.gmail.com
Smtp__Port=587
Smtp__User=tu-email@gmail.com
Smtp__Pass=tu-app-password-gmail
Smtp__From=tu-email@gmail.com
Jwt__Key=tu-clave-secreta-minimo-32-caracteres
FRONTEND_URL=http://localhost:5173
```

### Backend `.env.production`

Usado para testing de producci√≥n local (mismo config que Azure):

```env
ConnectionStrings__DefaultConnection=Server=tcp:tu-servidor.database.windows.net,1433;Initial Catalog=taskflow-db;User ID=tu-usuario;Password=tu-password;
Smtp__Host=smtp.gmail.com
Smtp__Port=587
Smtp__User=tu-email@gmail.com
Smtp__Pass=tu-app-password-gmail
Smtp__From=tu-email@gmail.com
Jwt__Key=tu-clave-jwt-produccion
FRONTEND_URL=https://tu-app.azurewebsites.net
```

### Backend `launchSettings.json`

Define perfiles de ejecuci√≥n para diferentes escenarios:

```json
{
  "profiles": {
    "http": {
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "production": {
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}
```

Uso:
- `dotnet run` ‚Üí Usa perfil "http" (Development)
- `dotnet run --launch-profile production` ‚Üí Usa perfil "production" (Production)

### Backend `appsettings.Production.json`

Plantilla para configuraci√≥n de producci√≥n (credenciales completadas por la plataforma de hosting):

```json
{
  "ConnectionStrings": {
    "DefaultConnection": ""
  },
  "Smtp": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "User": "",
    "Pass": "",
    "From": "TaskFlow <tu-email@gmail.com>"
  },
  "Jwt": {
    "Key": "",
    "Issuer": "TaskFlowApi",
    "Audience": "TaskFlowClient",
    "ExpiresInMinutes": 60
  },
   "AI": {
      "Provider": "huggingface",
      "ApiKey": "hf_your_token",
      "Model": "HuggingFaceTB/SmolLM3-3B",
      "BaseUrl": "https://router.huggingface.co",
      "TimeoutSeconds": 90
   }
}
```

## üîÑ Flujos de Trabajo

### Flujo 1: Desarrollo (Hot-Reload)

**Caso de uso**: Desarrollo activo con recarga autom√°tica

**Frontend**:
```bash
cd taskflow-frontend
npm run dev
# Carga autom√°ticamente .env.development
# URL del Backend: http://localhost:5149
```

**Backend**:
```bash
cd TaskFlow.Api
dotnet run
# Carga autom√°ticamente archivo .env
# ASPNETCORE_ENVIRONMENT=Development (por defecto)
```

**Resultado**: Frontend en `http://localhost:5173`, Backend en `http://localhost:5149`

---

### Flujo 2: Testing de Producci√≥n Local (con Azure DB)

**Caso de uso**: Probar configuraci√≥n de producci√≥n localmente con Azure SQL Database

**Backend**:
```bash
cd TaskFlow.Api
dotnet run --launch-profile production
# Carga .env.production
# Conecta a Azure SQL Database
# ASPNETCORE_ENVIRONMENT=Production
```

**Frontend**:
```bash
cd taskflow-frontend
npm run dev
# Carga .env.development (apunta a localhost:5149)
```

**Resultado**: Frontend en `http://localhost:5173`, Backend en `http://localhost:5149` con configuraci√≥n de producci√≥n y Azure DB

---

### Flujo 3: Testing de Build de Producci√≥n Integrado

**Caso de uso**: Probar build de producci√≥n localmente con frontend servido desde backend

**Frontend**:
```bash
cd taskflow-frontend
npm run build
# Usa autom√°ticamente .env.production
# Crea carpeta dist/ con build de producci√≥n
```

**Backend** (usando deployment integrado):
```powershell
# Desde la ra√≠z del proyecto
.\copy-frontend-to-wwwroot.ps1
cd TaskFlow.Api
dotnet run --launch-profile production
# Sirve el frontend desde wwwroot/
# Acceder en http://localhost:5149
```

**Resultado**: Entorno completo similar a producci√≥n en `http://localhost:5149`

---

### Flujo 4: Deployment en Nube (Producci√≥n)

**Caso de uso**: Desplegar a Railway, Render o Azure

**Build del Frontend**:
```bash
cd taskflow-frontend
npm run build
# Usa .env.production autom√°ticamente
```

**Configuraci√≥n del Backend**:
- Configurar variables de entorno en el dashboard de la plataforma de hosting
- La plataforma configura `ASPNETCORE_ENVIRONMENT=Production`
- Backend lee desde `appsettings.Production.json` + variables de entorno

**Ejemplo con Railway**:
```bash
# Variables de entorno configuradas en el dashboard de Railway:
ConnectionStrings__DefaultConnection=postgresql://user:pass@host:5432/db
Smtp__Host=smtp.gmail.com
Smtp__User=tu-email@gmail.com
Smtp__Pass=tu-contrase√±a-de-aplicaci√≥n
Jwt__Key=tu-clave-jwt-de-produccion
FRONTEND_URL=https://tu-app.up.railway.app
```

**Resultado**: App corriendo en Railway con base de datos PostgreSQL

## üöÄ Cambio Entre Entornos

### ¬°No Se Necesitan Cambios Manuales!

La belleza de esta configuraci√≥n es que **nunca** necesit√°s editar manualmente archivos de entorno para cambiar entre desarrollo y producci√≥n.

| Tarea | Comando | Archivos Usados |
|-------|---------|-----------------|
| Iniciar servidor dev | `npm run dev` + `dotnet run` | `.env.development` (ambos) |
| Probar producci√≥n con Azure DB | `npm run dev` + `dotnet run --launch-profile production` | `.env.development` (frontend), `.env.production` (backend) |
| Build para producci√≥n | `npm run build` | `.env.production` |
| Probar producci√≥n localmente | `.\copy-frontend-to-wwwroot.ps1` + `dotnet run --launch-profile production` | `.env.production` (ambos) |
| Desplegar a nube (Azure) | Push a git ‚Üí GitHub Actions | Variables de entorno de Azure App Service |

### Cu√°ndo Actualizar Cada Archivo

**Actualizar `.env.development`**:
- Cuando cambia el puerto local del backend
- Cuando obten√©s una nueva API key de Google Maps
- Nunca commitear esto si contiene secretos

**Actualizar `.env.production`**:
- Antes del primer deployment a producci√≥n (configurar tu dominio)
- Cuando despleg√°s a un nuevo dominio
- Cuando cambian las API keys de producci√≥n

**Actualizar `TaskFlow.Api/.env.development`**:
- Cuando cambia la conexi√≥n a Azure SQL Database
- Cuando rot√°s credenciales SMTP
- Cuando gener√°s nuevas claves JWT para testing
- **Nunca commitear este archivo** (ya est√° en .gitignore)

**Actualizar `TaskFlow.Api/.env.production`**:
- Cuando cambia el connection string de Azure SQL en producci√≥n
- Cuando rot√°s SMTP App Password
- Cuando cambia la URL del frontend (FRONTEND_URL)
- **Nunca commitear este archivo** (ya est√° en .gitignore)

**Actualizar `launchSettings.json`**:
- Para agregar nuevos perfiles de ejecuci√≥n
- Para cambiar variables de entorno por perfil
- Pod√©s commitear esto (no contiene secretos)

**Actualizar `appsettings.Production.json`**:
- Cuando agreg√°s nuevas secciones de configuraci√≥n
- Para configurar valores por defecto espec√≠ficos de producci√≥n
- Pod√©s commitear esto (no deber√≠a contener secretos)

## üîí Mejores Pr√°cticas de Seguridad

### ‚úÖ HACER:
- ‚úÖ Usar archivos `.env.example` como plantillas
- ‚úÖ Mantener secretos en archivos `.env` (ignorados por git)
- ‚úÖ Usar variables de entorno en producci√≥n
- ‚úÖ Rotar claves JWT regularmente
- ‚úÖ Usar claves diferentes para dev/prod

### ‚ùå NO HACER:
- ‚ùå Commitear archivos `.env` con secretos
- ‚ùå Hardcodear secretos en c√≥digo fuente
- ‚ùå Usar secretos de producci√≥n en desarrollo
- ‚ùå Compartir archivos `.env` por chat/email
- ‚ùå Usar claves JWT d√©biles (< 32 caracteres)

## üêõ Soluci√≥n de Problemas

### Problema: Frontend no puede conectarse al backend

**S√≠ntomas**: Llamadas a API fallan, errores CORS, errores de red

**Soluciones**:
1. Verificar `VITE_ROOT_URL` en el archivo de entorno actual:
   ```bash
   # Desarrollo
   cat taskflow-frontend/.env.development
   
   # Producci√≥n
   cat taskflow-frontend/.env.production
   ```

2. Verificar que el backend est√© corriendo en el puerto esperado:
   ```bash
   # Deber√≠a mostrar "Now listening on: http://localhost:5149"
   cd TaskFlow.Api
   dotnet run
   ```

3. Recompilar frontend si cambiaste archivos `.env`:
   ```bash
   # Vite solo lee archivos .env en tiempo de build
   npm run dev  # Para desarrollo
   npm run build  # Para producci√≥n
   ```

---

### Problema: Backend no puede conectarse a la base de datos

**S√≠ntomas**: Errores de migraci√≥n, errores "Cannot open database"

**Soluciones**:
1. Verificar cadena de conexi√≥n en archivo `.env`:
   ```bash
   cat TaskFlow.Api/.env | grep ConnectionStrings
   ```

2. Verificar que SQL Server est√© corriendo:
   ```bash
   # Windows
   Get-Service MSSQL*
   
   # O verificar en SQL Server Configuration Manager
   ```

3. Probar formato de cadena de conexi√≥n:
   ```
   # SQL Server Express local
   Server=localhost\SQLEXPRESS;Database=TaskFlowDb;Trusted_Connection=True;TrustServerCertificate=True;
   
   # SQL Server con credenciales
   Server=localhost;Database=TaskFlowDb;User Id=sa;Password=TuContrase√±a;TrustServerCertificate=True;
   ```

---

### Problema: Links de confirmaci√≥n de email van a URL incorrecta

**S√≠ntomas**: Links de email apuntan a localhost en producci√≥n, o puerto incorrecto

**Soluciones**:
1. Verificar variable de entorno `FRONTEND_URL`:
   ```bash
   # Desarrollo (archivo .env)
   FRONTEND_URL=http://localhost:5149
   
   # Producci√≥n (variable de entorno de la plataforma)
   FRONTEND_URL=https://tu-dominio.com
   ```

2. Verificar que el backend est√© leyendo la variable:
   ```csharp
   // En AuthService.cs, el link se genera as√≠:
   var confirmationLink = $"{_configuration["FRONTEND_URL"]}/confirm-email?token={token}";
   ```

3. Reiniciar backend despu√©s de cambiar variables de entorno

---

### Problema: Cambios a archivos `.env` no tienen efecto

**S√≠ntomas**: La app sigue usando valores viejos despu√©s de editar `.env`

**Soluciones**:
1. **Frontend**: Reiniciar servidor dev o recompilar:
   ```bash
   # Detener servidor dev (Ctrl+C)
   npm run dev  # Iniciar nuevamente
   
   # O para build de producci√≥n:
   npm run build
   ```

2. **Backend**: Reiniciar aplicaci√≥n:
   ```bash
   # Detener backend (Ctrl+C)
   dotnet run  # Iniciar nuevamente
   ```

3. **Limpiar cach√© de build** si los problemas persisten:
   ```bash
   # Frontend
   rm -rf node_modules/.vite
   npm run dev
   
   # Backend
   dotnet clean
   dotnet build
   ```

---

### Problema: Build de producci√≥n funciona localmente pero falla en la nube

**S√≠ntomas**: La app funciona con `dotnet run` pero falla en Railway/Render

**Soluciones**:
1. Verificar que las variables de entorno est√©n configuradas en el dashboard de la plataforma

2. Verificar que `appsettings.Production.json` exista y sea JSON v√°lido

3. Verificar logs en el dashboard de la plataforma para errores espec√≠ficos

4. Asegurar formato correcto de cadena de conexi√≥n PostgreSQL para la nube:
   ```
   # Formato PostgreSQL de Railway/Render
   postgresql://user:password@hostname:5432/database?sslmode=require
   ```

5. Verificar que las migraciones est√©n aplicadas (Railway ejecuta migraciones autom√°ticamente si est√° configurado)

## ÔøΩ CI/CD Secrets Reference

### GitHub Actions ‚Üí Azure App Service

| Purpose | GitHub Secret | Azure App Setting | Notes |
|---------|---------------|-------------------|-------|
| SQL connection string | `AZURE_SQL_CONNECTION_STRING` | `ConnectionStrings__DefaultConnection` | Required by API & Functions |
| Storage connection | `AZURE_STORAGE_CONNECTION_STRING` | `AzureStorage__ConnectionString`, `AzureWebJobsStorage` | Functions need both values |
| Storage container name | `AZURE_STORAGE_CONTAINER_NAME` | `AzureStorage__ContainerName` | Container must exist |
| SMTP host | `SMTP_HOST` | `Smtp__Host` | |
| SMTP port | `SMTP_PORT` | `Smtp__Port` | Keep as string in Azure |
| SMTP user | `SMTP_USER` | `Smtp__User` | |
| SMTP password | `SMTP_PASSWORD` | `Smtp__Pass` | Use app password |
| SMTP from | `SMTP_FROM` | `Smtp__From` | Optional display name |
| JWT signing key | `JWT_KEY` | `Jwt__Key` | ‚â• 32 characters |
| JWT issuer | `JWT_ISSUER` | `Jwt__Issuer` | |
| JWT audience | `JWT_AUDIENCE` | `Jwt__Audience` | |
| Frontend URL | `FRONTEND_URL` | `Frontend__Url` | Used for CORS & emails |
| Vite root URL | `VITE_ROOT_URL` | (Vite `.env` only) | GitHub Actions writes `.env.production` |
| Google Maps API key | `GOOGLE_MAPS_API_KEY` | `VITE_GOOGLE_MAPS_API_KEY` | Optional |
| AI provider | `AI_PROVIDER` | `AI__PROVIDER` | Default `huggingface` |
| AI token | `AI_API_KEY` | `AI__APIKEY` | Hugging Face Read token |
| AI model | `AI_MODEL` | `AI__MODEL` | e.g. `HuggingFaceTB/SmolLM3-3B` |
| AI base URL | `AI_BASE_URL` | `AI__BASEURL` | Usually default |
| AI timeout | `AI_TIMEOUT_SECONDS` | `AI__TIMEOUTSECONDS` | Optional |
| Azure login client id | `AZUREAPPSERVICE_CLIENTID_*` | n/a | Used by `azure/login` |
| Azure tenant id | `AZUREAPPSERVICE_TENANTID_*` | n/a | |
| Azure subscription id | `AZUREAPPSERVICE_SUBSCRIPTIONID_*` | n/a | |
| Azure Functions app name | `AZURE_FUNCTIONAPP_NAME` | n/a | Used in workflows for `taskflow-functions` |

### Using `scripts\use-env.ps1`

1. Store secret files under `config/secrets/<profile>/` (they stay out of git).
2. Run `pwsh scripts/use-env.ps1 local` or `pwsh scripts/use-env.ps1 azure` in each PowerShell session (add `-Persist` to write user-level vars).
3. The script sets process variables and copies:
   - `TaskFlow.Api/appsettings.Local.json`
   - `TaskFlow.Functions/local.settings.json`
   - `taskflow-frontend/.env.local`
4. Restart shells after rotations to pick up new values.

### Rotating Sensitive Keys

- **SQL**: rotate credentials in Azure SQL, then update `ConnectionStrings__DefaultConnection` (Azure + GitHub).
- **JWT**: generate a new 256-bit key (`dotnet user-jwts key --display`) and update `Jwt__Key` everywhere.
- **SMTP**: create a fresh app password and update `Smtp__Pass`.
- **Storage**: rotate Storage Account keys; update `AzureStorage__ConnectionString` and `AzureWebJobsStorage`.
- **Hugging Face**: revoke and recreate the Read token; update `AI__APIKEY` in secrets and local files.
- Record rotation dates in your internal runbook.

## üîë Referencia de Secrets

### GitHub Actions ‚Üí Azure App Service

| Prop√≥sito | GitHub Secret | App Setting de Azure | Notas |
|-----------|---------------|----------------------|-------|
| Cadena de conexi√≥n SQL | `AZURE_SQL_CONNECTION_STRING` | `ConnectionStrings__DefaultConnection` | Obligatoria para API y Functions |
| Conexi√≥n a Storage | `AZURE_STORAGE_CONNECTION_STRING` | `AzureStorage__ConnectionString`, `AzureWebJobsStorage` | Functions necesita ambos |
| Nombre de contenedor | `AZURE_STORAGE_CONTAINER_NAME` | `AzureStorage__ContainerName` | Crear antes el contenedor |
| Host SMTP | `SMTP_HOST` | `Smtp__Host` | |
| Puerto SMTP | `SMTP_PORT` | `Smtp__Port` | Azure espera strings |
| Usuario SMTP | `SMTP_USER` | `Smtp__User` | |
| Password SMTP | `SMTP_PASSWORD` | `Smtp__Pass` | Usar app password |
| Remitente SMTP | `SMTP_FROM` | `Smtp__From` | Se puede incluir nombre |
| Clave JWT | `JWT_KEY` | `Jwt__Key` | ‚â• 32 caracteres |
| Issuer JWT | `JWT_ISSUER` | `Jwt__Issuer` | |
| Audience JWT | `JWT_AUDIENCE` | `Jwt__Audience` | |
| URL del frontend | `FRONTEND_URL` | `Frontend__Url` | Para CORS y correos |
| Root URL de Vite | `VITE_ROOT_URL` | (solo `.env` de Vite) | Se escribe en el build |
| API key de Google Maps | `GOOGLE_MAPS_API_KEY` | `VITE_GOOGLE_MAPS_API_KEY` | Opcional |
| Proveedor de IA | `AI_PROVIDER` | `AI__PROVIDER` | Default `huggingface` |
| Token de IA | `AI_API_KEY` | `AI__APIKEY` | Token de lectura de Hugging Face |
| Modelo de IA | `AI_MODEL` | `AI__MODEL` | Ej. `HuggingFaceTB/SmolLM3-3B` |
| Base URL de IA | `AI_BASE_URL` | `AI__BASEURL` | Normalmente default |
| Timeout IA | `AI_TIMEOUT_SECONDS` | `AI__TIMEOUTSECONDS` | Opcional |
| Client ID de Azure | `AZUREAPPSERVICE_CLIENTID_*` | n/a | Uso exclusivo del action |
| Tenant ID de Azure | `AZUREAPPSERVICE_TENANTID_*` | n/a | |
| Subscription ID de Azure | `AZUREAPPSERVICE_SUBSCRIPTIONID_*` | n/a | |
| Nombre de Function App | `AZURE_FUNCTIONAPP_NAME` | n/a | Usado en los workflows |

### C√≥mo usar `scripts\use-env.ps1`

1. Guard√° tus archivos de secretos en `config/secrets/<perfil>/` (fuera de git).
2. Ejecut√° `pwsh scripts/use-env.ps1 local` o `pwsh scripts/use-env.ps1 azure` en cada sesi√≥n (sum√° `-Persist` si quer√©s guardarlos a nivel usuario).
3. El script setea variables del proceso y copia:
   - `TaskFlow.Api/appsettings.Local.json`
   - `TaskFlow.Functions/local.settings.json`
   - `taskflow-frontend/.env.local`
4. Reinici√° las terminales despu√©s de rotaciones para tomar los nuevos valores.

### Rotaci√≥n de Credenciales

- **SQL**: rot√° la contrase√±a en Azure SQL y actualiz√° `ConnectionStrings__DefaultConnection` (Azure + GitHub).
- **JWT**: gener√° una clave de 256 bits (`dotnet user-jwts key --display`) y actualiz√° `Jwt__Key`.
- **SMTP**: ped√≠ un app password nuevo y actualiz√° `Smtp__Pass`.
- **Storage**: rot√° las keys del Storage Account; actualiz√° `AzureStorage__ConnectionString` y `AzureWebJobsStorage`.
- **Hugging Face**: revoc√° el token y carg√° el nuevo en `AI__APIKEY` y archivos locales.
- Anot√° la fecha de cada rotaci√≥n.

## ÔøΩüìö Recursos Adicionales

- [Vite Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
- [ASP.NET Core Configuration](https://learn.microsoft.com/es-es/aspnet/core/fundamentals/configuration/)
- [DotNetEnv Library](https://github.com/tonerdo/dotnet-env)
- [Railway Environment Variables](https://docs.railway.app/develop/variables)

---

**√öltima Actualizaci√≥n**: Enero 2025  
**Versi√≥n de TaskFlow**: 1.0
